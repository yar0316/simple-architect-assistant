name: GitHub Release Distribution

on:
  push:
    tags:
      - 'v*'  # v1.0.0, v1.2.3 ãªã©ã®ã‚¿ã‚°ãŒãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸæ™‚ã«å®Ÿè¡Œ
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    inputs:
      version:
        description: 'ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ (ä¾‹: v1.0.0)'
        required: true
        default: 'v1.0.0'

env:
  PYTHON_VERSION: '3.11'

jobs:
  build-and-release:
    name: Build and Create GitHub Release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å®Œå…¨ãªå±¥æ­´ã‚’å–å¾—ï¼ˆãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆç”Ÿæˆã«å¿…è¦ï¼‰
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y zip
    
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Extract version from tag or input
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="${{ github.ref_name }}"
        fi
        # v prefix ã‚’å‰Šé™¤
        VERSION_NUMBER=${VERSION#v}
        echo "version=${VERSION_NUMBER}" >> $GITHUB_OUTPUT
        echo "tag=${VERSION}" >> $GITHUB_OUTPUT
        echo "Using version: ${VERSION_NUMBER}"
    
    - name: Build desktop application
      run: |
        python build_desktop_app.py --clean --version "${{ steps.version.outputs.version }}"
    
    - name: Create distribution archive
      run: |
        cd dist
        zip -r simple-architect-assistant-${{ steps.version.outputs.version }}.zip simple-architect-assistant/
        
        # ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’å–å¾—
        FILE_SIZE=$(stat -c%s "simple-architect-assistant-${{ steps.version.outputs.version }}.zip")
        FILE_SIZE_MB=$(echo "scale=1; $FILE_SIZE / 1024 / 1024" | bc)
        echo "archive_size=${FILE_SIZE_MB}MB" >> $GITHUB_ENV
        
        # SHA256ãƒãƒƒã‚·ãƒ¥ã‚’è¨ˆç®—
        SHA256=$(sha256sum "simple-architect-assistant-${{ steps.version.outputs.version }}.zip" | cut -d' ' -f1)
        echo "archive_sha256=${SHA256}" >> $GITHUB_ENV
        echo "SHA256: ${SHA256}"
    
    - name: Generate release notes
      id: release_notes
      run: |
        RELEASE_NOTES=$(cat <<EOF
        ## ğŸ‰ Simple Architect Assistant ${{ steps.version.outputs.tag }}
        
        AWS Bedrock (Claude 4 Sonnet) ã¨MCPçµ±åˆã«ã‚ˆã‚‹AWSã‚¤ãƒ³ãƒ•ãƒ©è¨­è¨ˆæ”¯æ´ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
        
        ### ğŸ“¦ é…å¸ƒæƒ…å ±
        - **ãƒ•ã‚¡ã‚¤ãƒ«å**: simple-architect-assistant-${{ steps.version.outputs.version }}.zip
        - **ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º**: ${archive_size}
        - **SHA256**: \`${archive_sha256}\`
        - **ãƒ“ãƒ«ãƒ‰æ—¥æ™‚**: $(date -u '+%Y-%m-%d %H:%M:%S') UTC
        
        ### ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †
        1. ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ»è§£å‡
        2. \`.streamlit/secrets.toml.example\` ã‚’ \`.streamlit/secrets.toml\` ã«ã‚³ãƒ”ãƒ¼
        3. AWSè¨­å®šã‚’ç·¨é›†ï¼ˆãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰
        4. \`simple-architect-assistant.exe\` ã‚’å®Ÿè¡Œ
        
        ### âš™ï¸ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
        - **AWSè¨­å®š**: \`.streamlit/secrets.toml\` ï¼ˆå¿…é ˆï¼‰
        - **MCPè¨­å®š**: \`config/mcp_config.json\` ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€æ–°æ©Ÿèƒ½è¿½åŠ æ™‚ï¼‰
        
        ### ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶
        - Windows 10ä»¥ä¸Š / macOS 10.15ä»¥ä¸Š / Linux (Ubuntu 18.04ä»¥ä¸Š)
        - AWS CLIè¨­å®šæ¸ˆã¿ç’°å¢ƒ
        - ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šï¼ˆMCPæ©Ÿèƒ½åˆ©ç”¨æ™‚ï¼‰
        
        ### ğŸ“‹ ä¸»ãªæ©Ÿèƒ½
        - AWSæ§‹æˆææ¡ˆãƒãƒ£ãƒƒãƒˆï¼ˆClaude 4 Sonnetï¼‰
        - Terraformã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
        - MCPçµ±åˆã«ã‚ˆã‚‹æ‹¡å¼µæ©Ÿèƒ½
        - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚³ã‚¹ãƒˆåˆ†æ
        - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ã«ã‚ˆã‚‹é«˜å¯ç”¨æ€§
        
        ### ğŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
        - **AWSèªè¨¼ã‚¨ãƒ©ãƒ¼**: \`aws configure list\` ã§è¨­å®šç¢ºèª
        - **MCPæ¥ç¶šã‚¨ãƒ©ãƒ¼**: \`config/mcp_config.json\` ã§ \`"disabled": true\` ã«è¨­å®šå¯èƒ½
        - **èµ·å‹•ãŒé…ã„**: åˆå›èµ·å‹•æ™‚ã¯ä¾å­˜é–¢ä¿‚èª­ã¿è¾¼ã¿ã®ãŸã‚æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™
        
        ### ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
        - [ãƒ“ãƒ«ãƒ‰ã‚¬ã‚¤ãƒ‰](BUILD.md)
        - [é…å¸ƒã‚¬ã‚¤ãƒ‰](docs/DISTRIBUTION_GUIDE.md)
        - [ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚¢ãƒ—ãƒªã‚¬ã‚¤ãƒ‰](docs/DESKTOP_APP_GUIDE.md)
        
        ### ğŸ†˜ ã‚µãƒãƒ¼ãƒˆ
        - Issues: https://github.com/yar0316/simple-architect-assistant/issues
        - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: README.md
        
        ---
        
        ### ãƒ•ã‚¡ã‚¤ãƒ«æ•´åˆæ€§ç¢ºèª
        ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¾Œã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ•ã‚¡ã‚¤ãƒ«ã®æ•´åˆæ€§ã‚’ç¢ºèªã§ãã¾ã™ï¼š
        \`\`\`bash
        # Windows (PowerShell)
        Get-FileHash simple-architect-assistant-${{ steps.version.outputs.version }}.zip -Algorithm SHA256
        
        # macOS/Linux
        sha256sum simple-architect-assistant-${{ steps.version.outputs.version }}.zip
        \`\`\`
        
        æœŸå¾…å€¤: \`${archive_sha256}\`
        EOF
        )
        
        # æ”¹è¡Œã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦GitHub Outputã«è¨­å®š
        echo "notes<<EOF" >> $GITHUB_OUTPUT
        echo "$RELEASE_NOTES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: "Simple Architect Assistant ${{ steps.version.outputs.tag }}"
        body: ${{ steps.release_notes.outputs.notes }}
        files: |
          dist/simple-architect-assistant-${{ steps.version.outputs.version }}.zip
        draft: false
        prerelease: false
        make_latest: true
        generate_release_notes: false  # ã‚«ã‚¹ã‚¿ãƒ ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ä½¿ç”¨
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      if: always()  # å¤±æ•—æ™‚ã§ã‚‚ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      with:
        name: desktop-app-${{ steps.version.outputs.version }}
        path: |
          dist/
          !dist/dist_config/
        retention-days: 30
    
    - name: Report deployment summary
      run: |
        echo "## ğŸ‰ GitHub Releaseä½œæˆå®Œäº†" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“¦ ãƒªãƒªãƒ¼ã‚¹æƒ…å ±" >> $GITHUB_STEP_SUMMARY
        echo "- **ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
        echo "- **ãƒ•ã‚¡ã‚¤ãƒ«**: simple-architect-assistant-${{ steps.version.outputs.version }}.zip" >> $GITHUB_STEP_SUMMARY
        echo "- **ã‚µã‚¤ã‚º**: ${archive_size}" >> $GITHUB_STEP_SUMMARY
        echo "- **SHA256**: \`${archive_sha256}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ”— ãƒªãƒ³ã‚¯" >> $GITHUB_STEP_SUMMARY
        echo "- [ãƒªãƒªãƒ¼ã‚¹ãƒšãƒ¼ã‚¸](https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }})" >> $GITHUB_STEP_SUMMARY
        echo "- [ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/simple-architect-assistant-${{ steps.version.outputs.version }}.zip)" >> $GITHUB_STEP_SUMMARY

  notify-completion:
    name: Notify Deployment Completion
    runs-on: ubuntu-latest
    needs: build-and-release
    if: success()
    
    steps:
    - name: Extract version
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="${{ github.ref_name }}"
        fi
        echo "tag=${VERSION}" >> $GITHUB_OUTPUT
    
    - name: Create deployment notification
      run: |
        echo "âœ… GitHub Releaseé…å¸ƒãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ" 
        echo ""
        echo "ğŸ“‹ é…å¸ƒæƒ…å ±:"
        echo "- ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}"
        echo "- ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ steps.version.outputs.tag }}"
        echo "- ãƒªãƒªãƒ¼ã‚¹URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
        echo ""
        echo "ğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
        echo "1. ãƒªãƒªãƒ¼ã‚¹ãƒšãƒ¼ã‚¸ã§ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’ç¢ºèª"
        echo "2. å¿…è¦ã«å¿œã˜ã¦ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ç·¨é›†"
        echo "3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é€šçŸ¥ã‚’å®Ÿæ–½"